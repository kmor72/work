<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Денежный поток облигации</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #004a99; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .loading { font-weight: bold; color: #555; }
        h2 { color: #333; }
    </style>
</head>
<body>

    <h2>Денежный поток по облигации <span id="isin">...</span></h2>
    <div id="loader" class="loading">Загрузка данных из MOEX ISS...</div>
    
    <table id="flow-table" style="display:none;">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Тип выплаты</th>
                <th>Размер (руб.)</th>
                <th>Записей в реестре</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <script>
        const ISIN = "RU000A107UU5";
        const url = `https://iss.moex.com/iss/securities/${ISIN}/bondization.json`;

        async function fetchBondData() {
            try {
                const response = await fetch(url);
                const json = await response.json();
                
                document.getElementById('isin').innerText = ISIN;

                // Функция для преобразования структуры MOEX в массив объектов
                const parseBlock = (blockName) => {
                    const block = json[blockName];
                    if (!block) return [];
                    return block.data.map(row => {
                        let obj = {};
                        block.columns.forEach((col, index) => {
                            obj[col.toLowerCase()] = row[index];
                        });
                        return obj;
                    });
                };

                const coupons = parseBlock('coupons');
                const amortizations = parseBlock('amortizations');

                // Объединяем потоки
                let fullFlow = [
                    ...coupons.map(c => ({
                        date: c.coupondate,
                        type: 'Купон',
                        value: c.value,
                        recordDate: c.recorddate
                    })),
                    ...amortizations.map(a => ({
                        date: a.amortdate,
                        type: 'Погашение/Амортизация',
                        value: a.value,
                        recordDate: a.recorddate
                    }))
                ];

                // Сортируем по дате
                fullFlow.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Рендерим таблицу
                const tbody = document.getElementById('table-body');
                fullFlow.forEach(item => {
                    const row = `<tr>
                        <td>${item.date}</td>
                        <td>${item.type}</td>
                        <td>${item.value.toFixed(2)}</td>
                        <td>${item.recordDate || '-'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

                document.getElementById('loader').style.display = 'none';
                document.getElementById('flow-table').style.display = 'table';

            } catch (error) {
                console.error("Ошибка при загрузке:", error);
                document.getElementById('loader').innerText = "Ошибка при загрузке данных.";
            }
        }

        fetchBondData();
    </script>
</body>
</html>
